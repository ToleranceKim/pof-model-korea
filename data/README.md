# Weather, Target(MODIS af_flag)

## 개요

1. **타겟 데이터(af_flag)**: MODIS 활성 화재 데이터 처리
2. **날씨 데이터**: 기상 변수(온도, 습도 등) 수집 및 처리

## 데이터 수집 및 전처리 과정

### 1. 타겟 데이터(af_flag) 처리

- **수집**: NASA FIRMS를 통해 MODIS 활성 화재 데이터 다운로드
- **전처리**: `process_af_flag.py`로 데이터 처리
  - 신뢰도 기준 필터링(기본값: 30)
  - 위도/경도를 0.1° 그리드로 변환
  - 날짜-그리드 조합별 화재 발생 여부 집계
- **검증**: `validate_af_flag.py`로 처리 결과 검증

### 2. 날씨 데이터 처리

#### 데이터 수집 옵션

1. **ERA5 (현재 사용 중)**

   - **해상도**: 0.25° 격자 (약 25km)
   - **장점**: 전 지구 커버리지, 다양한 변수, 신뢰성 높음
   - **단점**: 0.1° 그리드와 불일치, 보간 필요
   - **출처**: [Copernicus Climate Data Store](https://cds.climate.copernicus.eu/cdsapp#!/dataset/reanalysis-era5-single-levels)

2. **ERA5-Land (이전 사용)**

   - **해상도**: 0.1° 격자 (약 10km)
   - **장점**: 높은 해상도, 육지 특화
   - **단점**: 한국 지역 상당수 누락
   - **출처**: [Copernicus Climate Data Store](https://cds.climate.copernicus.eu/cdsapp#!/dataset/reanalysis-era5-land)

3. **기상청 수치모델 자료**

   - **해상도**: LDAPS(1.5km), KLAPS(5km)
   - **장점**: 초고해상도, 한반도 특화
   - **단점**: 과거 데이터 시리즈 확보 어려움
   - **출처**: [기상자료개방포털](https://data.kma.go.kr)

4. **ECMWF HRES (High Resolution Forecast)**
   - **해상도**: 0.1° 격자
   - **장점**: 고해상도, 다양한 변수
   - **단점**: 접근성, 비용
   - **출처**: [ECMWF](https://www.ecmwf.int/en/forecasts/datasets)

#### ERA5-Land와 ERA5 데이터 문제점

**ERA5-Land 문제점**:

- 한국 지역의 일부 격자점 누락 (약 8%)
- 산불 데이터 격자와 불일치
- 수집 범위 설정과 실제 수집 데이터 범위 차이

**ERA5 데이터 사용 시 격자 단위 차이**:

- ERA5 데이터는 0.25° 간격으로 제공됨
- 기존 코드는 0.1° 격자 기준으로 작성됨
- 격자 해상도 차이로 인한 grid_id 불일치 발생

#### 보간법을 통한 해결

ERA5(0.25°) 데이터를 0.1° 해상도로 보간하는 방식을 채택:

- 이중선형 보간법(Bilinear Interpolation) 사용
- 격자 밀도를 높여 산불 데이터와 일치시킴
- 실제 관측 값이 아닌 추정치이므로 정확도는 원본보다 낮을 수 있음

#### 날씨 데이터 처리 과정

- **수집**: `collect_weather.py`로 ERA5 데이터 수집
  - 날씨 변수: 기온, 이슬점 온도, 풍속, 강수량
- **전처리**: `process_weather.py`로 날씨 파일 처리
  - 관련 변수 추출
  - 보간법을 통해 0.1° 그리드로 변환
- **결합**: `combine_weather_data.py`로 처리된 날씨 파일 통합

#### 날씨 데이터 변수

ERA5에서 수집하는 주요 변수 목록:

| 변수명  | 설명                | 원본 단위 |
| ------- | ------------------- | --------- |
| t2m     | 지표 2m 기온        | 켈빈(K)   |
| td2m    | 지표 2m 이슬점 온도 | 켈빈(K)   |
| 10u     | 10m 동서 방향 풍속  | m/s       |
| 10v     | 10m 남북 방향 풍속  | m/s       |
| tp      | 총 강수량           | m         |
| wind10m | 풍속(계산값)        | m/s       |

#### 풍속 계산 방법

풍속(wind10m)은 10u(동서 방향)과 10v(남북 방향) 성분에서 다음 공식으로 계산:

```
wind10m = sqrt(10u² + 10v²)
```

#### 시간별 데이터 일별 집계 방법

ERA5 데이터는 시간별로 제공되며, 다음과 같이 일별로 집계됩니다:

| 변수    | 집계 방법 | 설명                                         |
| ------- | --------- | -------------------------------------------- |
| t2m     | 일 평균   | 각 그리드 셀의 24시간 데이터에서 평균값 계산 |
| td2m    | 일 평균   | 각 그리드 셀의 24시간 이슬점 온도 평균       |
| wind10m | 일 평균   | 각 그리드 셀의 24시간 풍속 평균              |
| tp      | 일 누적   | 24시간 동안의 총 강수량 합계                 |

### 3. 데이터 통합

- **결합**: `join_weather_target.py`로 날씨와 타겟 데이터 결합
  - 날짜 및 그리드 ID 기준으로 결합
  - 결과: 각 행은 특정 날짜의 그리드 셀 데이터 포함

## 그리드 시스템

0.1도 전역 그리드 시스템으로 모든 데이터 통합:

- 그리드 ID = (lat_index + 900) \* 3600 + (lon_index + 1800)
- lat_index = floor(latitude \* 10)
- lon_index = floor(longitude \* 10)

## 데이터 시각화

`visualize_af_flag.py`로 화재 분포 시각화:

- 연도별 화재 발생 지도 생성
- 월별 화재 발생 빈도 차트 생성
- af_flag 누락 여부 검증

## 보간법(Interpolation) 설명

### 개요

보간법은 알려진 데이터 포인트 사이의 값을 추정하는 방법입니다. ERA5 데이터(0.25°)를 0.1° 해상도로 변환할 때 사용됩니다.

### 주요 보간법

1. **최근접 이웃 보간법(Nearest Neighbor)**

   - 가장 가까운 기존 데이터 포인트의 값을 그대로 사용
   - 장점: 단순하고 빠름, 원본 값 보존
   - 단점: 계단 현상 발생, 부드럽지 않음
   - 적합: 범주형 데이터

2. **이중선형 보간법(Bilinear Interpolation)** [권장]

   - 주변 4개 격자점의 가중 평균 계산
   - 장점: 부드러운 결과, 효율적인 계산
   - 단점: 곡률 특성 반영 못함
   - 적합: 연속적인 기상 변수(온도, 습도 등)

3. **이중입방 보간법(Bicubic Interpolation)**

   - 주변 16개 격자점 사용하여 더 부드러운 보간
   - 장점: 더 부드러운 결과, 곡률 보존
   - 단점: 계산 비용 높음
   - 적합: 더 부드러운 결과가 필요할 때

4. **스플라인 보간법(Spline Interpolation)**
   - 조각별 다항식 함수로 부드러운 곡선 생성
   - 장점: 가장 부드러운 결과, 물리적 특성 보존
   - 단점: 계산 복잡성 높음
   - 적합: 고해상도 결과가 필요한 경우

### 구현 방법

xarray 라이브러리를 사용하여 보간법 구현:

```python
import xarray as xr

# 원본 데이터셋 로드
ds = xr.open_dataset('era5_data.nc')

# 새로운 좌표 생성 (0.1° 간격)
new_lats = np.arange(33.0, 39.1, 0.1)
new_lons = np.arange(124.0, 132.1, 0.1)

# 이중선형 보간 적용
ds_interp = ds.interp(latitude=new_lats, longitude=new_lons, method='linear')

# 결과 저장
ds_interp.to_netcdf('era5_interpolated_0.1deg.nc')
```
